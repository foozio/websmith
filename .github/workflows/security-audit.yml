name: Security Audit

on:
  schedule:
    # Run security audit weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:  # Allow manual triggering

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate --json > audit-report.json || true
      
      - name: Run audit-ci for detailed report
        run: npx audit-ci --moderate --report > detailed-audit-report.txt || true
      
      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json=snyk-report.json || true
      
      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
      
      - name: Check for outdated dependencies
        run: npm outdated --json > outdated-report.json || true
      
      - name: Generate security summary
        id: security-summary
        run: |
          echo "# Security Audit Report" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count vulnerabilities from npm audit
          if [ -f audit-report.json ]; then
            VULNS=$(cat audit-report.json | jq '.vulnerabilities | length' 2>/dev/null || echo "0")
            echo "## ðŸ“Š Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            echo "- npm audit vulnerabilities: $VULNS" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Count outdated packages
          if [ -f outdated-report.json ]; then
            OUTDATED=$(cat outdated-report.json | jq 'keys | length' 2>/dev/null || echo "0")
            echo "- Outdated packages: $OUTDATED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- Review and update dependencies with known vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "- Consider updating outdated packages to latest stable versions" >> $GITHUB_STEP_SUMMARY
          echo "- Run \`npm audit fix\` to automatically fix fixable vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "- Review CodeQL findings for potential security issues" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload audit reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-reports
          path: |
            audit-report.json
            detailed-audit-report.txt
            snyk-report.json
            outdated-report.json
          retention-days: 30
      
      - name: Create issue for critical findings
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let body = '# ðŸ”’ Security Audit Report\n\n';
            body += 'A security audit was run and found issues that need attention.\n\n';
            
            if (fs.existsSync('audit-report.json')) {
              const audit = JSON.parse(fs.readFileSync('audit-report.json', 'utf8'));
              const vulnCount = Object.keys(audit.vulnerabilities || {}).length;
              if (vulnCount > 0) {
                body += `## npm Audit\nFound ${vulnCount} vulnerabilities.\n\n`;
              }
            }
            
            if (fs.existsSync('outdated-report.json')) {
              const outdated = JSON.parse(fs.readFileSync('outdated-report.json', 'utf8'));
              const outdatedCount = Object.keys(outdated).length;
              if (outdatedCount > 0) {
                body += `## Outdated Packages\nFound ${outdatedCount} outdated packages.\n\n`;
              }
            }
            
            body += '## Next Steps\n';
            body += '1. Review the detailed audit reports in the workflow artifacts\n';
            body += '2. Run `npm audit fix` to address fixable vulnerabilities\n';
            body += '3. Update dependencies to latest stable versions\n';
            body += '4. Test thoroughly after updates\n\n';
            body += 'This issue was automatically created by the security audit workflow.';
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Security Audit Issues - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['security', 'dependencies', 'automated']
            });

  update-dependencies:
    runs-on: ubuntu-latest
    needs: security-audit
    if: github.event_name == 'schedule'  # Only auto-update on scheduled runs
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Update dependencies (patch only)
        run: |
          npm update --save
          npm audit fix --audit-level=moderate || true
      
      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "chore: auto-update dependencies [security]"
          git push
